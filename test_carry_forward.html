<!DOCTYPE html>
<html>
<head>
    <title>Test Carry Forward</title>
    <style>
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .opening-balance { background-color: #f0f9ff; font-weight: bold; }
        .test-section { margin: 20px 0; padding: 20px; border: 2px solid #ddd; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Test Balance Carry-Forward</h1>
    
    <div class="test-section">
        <h2>November 2021 Statement</h2>
        <button onclick="testNovember()">Load November 2021</button>
        <div id="november-results"></div>
    </div>
    
    <div class="test-section">
        <h2>December 2021 Statement</h2>
        <button onclick="testDecember()">Load December 2021</button>
        <div id="december-results"></div>
    </div>
    
    <div class="test-section">
        <h2>July 2025 Statement (Verification)</h2>
        <button onclick="testJuly()">Load July 2025</button>
        <div id="july-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Balance Continuity Test</h2>
        <button onclick="testContinuity()">Test Balance Continuity</button>
        <div id="continuity-results"></div>
    </div>
    
    <script>
        let novemberStatement = null;
        let decemberStatement = null;
        let julyStatement = null;
        
        async function testNovember() {
            try {
                const response = await fetch('http://127.0.0.1:8081/analytics/api/monthly-statement?company=cgge&year=2021&month=11');
                const data = await response.json();
                
                if (data.success) {
                    novemberStatement = data.statement;
                    let html = `
                        <h3>November 2021 - CGGE</h3>
                        <p><strong>Opening Balance:</strong> HK$${novemberStatement.opening_balance.toFixed(2)}</p>
                        <p><strong>Closing Balance:</strong> HK$${novemberStatement.closing_balance.toFixed(2)}</p>
                        <p><strong>Transactions:</strong> ${novemberStatement.transactions.length}</p>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th><th>Nature</th><th>Party</th><th>Debit</th><th>Credit</th><th>Balance</th><th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="opening-balance">
                                    <td>2021-11-01</td><td>Opening Balance</td><td>Brought Forward</td>
                                    <td></td><td></td><td>HK$${novemberStatement.opening_balance.toFixed(2)}</td>
                                    <td>Opening balance for November 2021</td>
                                </tr>
                    `;
                    
                    novemberStatement.transactions.forEach(tx => {
                        html += `
                            <tr>
                                <td>${tx.date}</td><td>${tx.nature}</td><td>${tx.party}</td>
                                <td>${tx.debit > 0 ? 'HK$' + parseFloat(tx.debit).toFixed(2) : ''}</td>
                                <td>${tx.credit > 0 ? 'HK$' + parseFloat(tx.credit).toFixed(2) : ''}</td>
                                <td>HK$${parseFloat(tx.balance).toFixed(2)}</td>
                                <td>${tx.description}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                <tr class="opening-balance">
                                    <td>2021-11-30</td><td>Closing Balance</td><td>Carry Forward</td>
                                    <td></td><td></td><td>HK$${novemberStatement.closing_balance.toFixed(2)}</td>
                                    <td>Closing balance for November 2021</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    
                    document.getElementById('november-results').innerHTML = html;
                } else {
                    document.getElementById('november-results').innerHTML = 'Error: ' + data.error;
                }
            } catch (error) {
                document.getElementById('november-results').innerHTML = 'Error: ' + error.message;
            }
        }
        
        async function testDecember() {
            try {
                const response = await fetch('http://127.0.0.1:8081/analytics/api/monthly-statement?company=cgge&year=2021&month=12');
                const data = await response.json();
                
                if (data.success) {
                    decemberStatement = data.statement;
                    let html = `
                        <h3>December 2021 - CGGE</h3>
                        <p><strong>Opening Balance:</strong> HK$${decemberStatement.opening_balance.toFixed(2)}</p>
                        <p><strong>Closing Balance:</strong> HK$${decemberStatement.closing_balance.toFixed(2)}</p>
                        <p><strong>Transactions:</strong> ${decemberStatement.transactions.length}</p>
                    `;
                    
                    if (decemberStatement.transactions.length === 0) {
                        html += `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th><th>Nature</th><th>Party</th><th>Debit</th><th>Credit</th><th>Balance</th><th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="opening-balance">
                                        <td>2021-12-01</td><td>Opening Balance</td><td>Brought Forward</td>
                                        <td></td><td></td><td>HK$${decemberStatement.opening_balance.toFixed(2)}</td>
                                        <td>Opening balance for December 2021</td>
                                    </tr>
                                    <tr class="opening-balance">
                                        <td>2021-12-31</td><td>Closing Balance</td><td>Carry Forward</td>
                                        <td></td><td></td><td>HK$${decemberStatement.closing_balance.toFixed(2)}</td>
                                        <td>Closing balance for December 2021</td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                    }
                    
                    document.getElementById('december-results').innerHTML = html;
                } else {
                    document.getElementById('december-results').innerHTML = 'Error: ' + data.error;
                }
            } catch (error) {
                document.getElementById('december-results').innerHTML = 'Error: ' + error.message;
            }
        }
        
        async function testJuly() {
            try {
                const response = await fetch('http://127.0.0.1:8081/analytics/api/monthly-statement?company=cgge&year=2025&month=7');
                const data = await response.json();
                
                if (data.success) {
                    julyStatement = data.statement;
                    let html = `
                        <h3>July 2025 - CGGE (Verification)</h3>
                        <p><strong>Opening Balance:</strong> HK$${julyStatement.opening_balance.toFixed(2)}</p>
                        <p><strong>Closing Balance:</strong> HK$${julyStatement.closing_balance.toFixed(2)} 
                        ${julyStatement.closing_balance.toFixed(2) === '554.77' ? '<span class="pass">[CORRECT]</span>' : '<span class="fail">[INCORRECT - Should be 554.77]</span>'}</p>
                        <p><strong>Transactions:</strong> ${julyStatement.transactions.length}</p>
                    `;
                    
                    document.getElementById('july-results').innerHTML = html;
                } else {
                    document.getElementById('july-results').innerHTML = 'Error: ' + data.error;
                }
            } catch (error) {
                document.getElementById('july-results').innerHTML = 'Error: ' + error.message;
            }
        }
        
        async function testContinuity() {
            if (!novemberStatement || !decemberStatement) {
                document.getElementById('continuity-results').innerHTML = '<p class="fail">Please load November and December statements first!</p>';
                return;
            }
            
            const novClosing = novemberStatement.closing_balance;
            const decOpening = decemberStatement.opening_balance;
            const match = Math.abs(novClosing - decOpening) < 0.01;
            
            let html = `
                <h3>Balance Continuity Check</h3>
                <p><strong>November 2021 Closing:</strong> HK$${novClosing.toFixed(2)}</p>
                <p><strong>December 2021 Opening:</strong> HK$${decOpening.toFixed(2)}</p>
                <p class="${match ? 'pass' : 'fail'}">
                    <strong>Balance Continuity:</strong> ${match ? 'PASS ✓' : 'FAIL ✗'}
                </p>
            `;
            
            if (match) {
                html += '<p class="pass">Perfect! The November closing balance correctly carries forward to December opening balance.</p>';
            } else {
                html += '<p class="fail">Error: Balance continuity is broken. Check the carry-forward logic.</p>';
            }
            
            document.getElementById('continuity-results').innerHTML = html;
        }
    </script>
</body>
</html>